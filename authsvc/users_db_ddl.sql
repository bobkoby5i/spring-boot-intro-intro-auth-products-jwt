--
-- POSGRESQL 
--


CREATE TABLE PERMISSIONS (
	ID              SERIAL PRIMARY KEY NOT NULL,
	PERMISSION_NAME VARCHAR(20)
);

CREATE TABLE USERS(
	ID       SERIAL PRIMARY KEY NOT NULL,
	NAME     VARCHAR(20) NOT NULL, 
	EMAIL_ID VARCHAR(255) NOT NULL, 
	PASSWORD VARCHAR(1000) NOT NULL
);

create unique index idx_user_email on users (user_name);

CREATE TABLE ROLES (
	ID SERIAL PRIMARY KEY NOT NULL, 
	ROLE_NAME VARCHAR(20)
);

CREATE TABLE ASSIGN_PERMISSION_TO_ROLE (
	ID SERIAL PRIMARY KEY NOT NULL, 
	PERMISSION_ID INT, 
	FOREIGN KEY(PERMISSION_ID) REFERENCES PERMISSION (ID), 
	ROLE_ID INT, 
	FOREIGN KEY(ROLE_ID) REFERENCES ROLE(ID)
);

CREATE TABLE ASSIGN_USER_TO_ROLE (
	ID SERIAL PRIMARY KEY NOT NULL, 
	USER_ID INT, 
	FOREIGN KEY(USER_ID) REFERENCES USERS(ID), 
	ROLE_ID INT, 
	FOREIGN KEY(ROLE_ID) REFERENCES ROLES(ID)
);


DELETE FROM PERMISSIONS;

INSERT INTO PERMISSIONS (ID, PERMISSION_NAME) VALUES (1, 'ITEM_CREATE');
INSERT INTO PERMISSIONS (ID, PERMISSION_NAME) VALUES (2, 'ITEM_EDIT');
INSERT INTO PERMISSIONS (ID, PERMISSION_NAME) VALUES (3, 'ITEM_DELETE');
INSERT INTO PERMISSIONS (ID, PERMISSION_NAME) VALUES (4, 'ITEM_VIEW_ALL');
INSERT INTO PERMISSIONS (ID, PERMISSION_NAME) VALUES (5, 'ITEM_VIEW');

INSERT INTO ROLES (ID, ROLE_NAME) VALUES (1, 'ADMIN');
INSERT INTO ROLES (ID, ROLE_NAME) VALUES (2, 'USER');

INSERT INTO USERS (ID, NAME, EMAIL_ID, PASSWORD) VALUES (1, 'bob', 'bob@gmail.com','$2a$10$jbIi/RIYNm5xAW9M7IaE5.WPw6BZgD8wcpkZUg0jm8RHPtdfDcMgm');
INSERT INTO USERS (ID, NAME, EMAIL_ID, PASSWORD) VALUES (2, 'tom', 'tom@gmail.com','$2a$10$jbIi/RIYNm5xAW9M7IaE5.WPw6BZgD8wcpkZUg0jm8RHPtdfDcMgm');

-- admin (CREATE, EDIT, DELETE, VIEW_ALL, VIEW)
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (1, 1);
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (2, 1);
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (3, 1);
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (4, 1);
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (5, 1);

-- user (VIEW_ALL, VIEW)
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (4, 2);
INSERT INTO ASSIGN_PERMISSION_TO_ROLE (PERMISSION_ID, ROLE_ID) VALUES (5, 2);


INSERT INTO ASSIGN_USER_TO_ROLE (USER_ID, ROLE_ID) VALUES (1, 1); --bob,admin
INSERT INTO ASSIGN_USER_TO_ROLE (USER_ID, ROLE_ID) VALUES (2, 2); --tom,user

SELECT * FROM USERS WHERE EMAIL_ID ='bob@gmail.com';


SELECT * FROM ROLES;
SELECT * FROM USERS;
SELECT * FROM PERMISSIONS;

SELECT u.name, u.email_id, r.role_name, permission_name
FROM  PERMISSIONS p, ASSIGN_PERMISSION_TO_ROLE pr, ROLES r, ASSIGN_USER_TO_ROLE ur, USERS u
WHERE u.ID = ur.user_id
  AND ur.ROLE_ID = r.ID
  AND pr.ROLE_ID = ur.ROLE_ID
  AND pr.PERMISSION_ID = p.ID;
  
  
SELECT DISTINCT p.PERMISSION_NAME
FROM PERMISSIONS p, ASSIGN_PERMISSION_TO_ROLE pr, ROLES r, ASSIGN_USER_TO_ROLE ur, USERS u
WHERE u.ID = ur.user_id
  AND ur.ROLE_ID = r.ID
  AND pr.ROLE_ID = ur.ROLE_ID
  AND pr.PERMISSION_ID = p.ID
  AND U.EMAIL_ID = 'bob@gmail.com'

C:\Users\bob>c:\PostgreSQL\pg11\bin\psql -U userdb_user -d userdb  -h localhost -p 5432
Haslo uzytkownika userdb_user:
psql (11.6)


SELECT * FROM ROLES;
 id | role_name
----+-----------
  1 | ADMIN
  2 | USER



SELECT * FROM USERS;
 id | name |   email_id    |                           password
----+------+---------------+--------------------------------------------------------------
  1 | bob  | bob@gmail.com | $2a$10$jbIi/RIYNm5xAW9M7IaE5.WPw6BZgD8wcpkZUg0jm8RHPtdfDcMgm
  2 | tom  | tom@gmail.com | $2a$10$jbIi/RIYNm5xAW9M7IaE5.WPw6BZgD8wcpkZUg0jm8RHPtdfDcMgm



SELECT * FROM PERMISSIONS;
 id | permission_name
----+-----------------
  1 | ITEM_CREATE
  2 | ITEM_EDIT
  3 | ITEM_DELETE
  4 | ITEM_VIEW_ALL
  5 | ITEM_VIEW



SELECT u.name, u.email_id, r.role_name, permission_name
FROM  PERMISSIONS p, ASSIGN_PERMISSION_TO_ROLE pr, ROLES r, ASSIGN_USER_TO_ROLE ur, USERS u
WHERE u.ID = ur.user_id
  AND ur.ROLE_ID = r.ID
  AND pr.ROLE_ID = ur.ROLE_ID
  AND pr.PERMISSION_ID = p.ID;
 name |   email_id    | role_name | permission_name
------+---------------+-----------+-----------------
 bob  | bob@gmail.com | ADMIN     | ITEM_VIEW
 bob  | bob@gmail.com | ADMIN     | ITEM_VIEW_ALL
 bob  | bob@gmail.com | ADMIN     | ITEM_DELETE
 bob  | bob@gmail.com | ADMIN     | ITEM_EDIT
 bob  | bob@gmail.com | ADMIN     | ITEM_CREATE
 tom  | tom@gmail.com | USER      | ITEM_VIEW
 tom  | tom@gmail.com | USER      | ITEM_VIEW_ALL





